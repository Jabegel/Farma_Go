<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmaGo - Novo Endereço</title>

    <link rel="stylesheet" href="/style.css">

    <style>
        body {
            background: #f8f9fa;
        }

        .endereco-container {
            max-width: 480px;
            background: #fff;
            margin: 40px auto;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.08);
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 15px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: #fff;
            border-radius: 10px;
            border: none;
            font-size: 17px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #005ce6;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            text-decoration: none;
            color: #007bff;
        }
    </style>

</head>
<body>

<header class="main-header">
    <a href="inicio_usuario.html" class="logo">FarmaGo</a>
    <nav>
        <a href="carrinho_checkout.html">Meus Pedidos</a>
        <a href="/SRC/LOGINS/login.html">Sair</a>
    </nav>
</header>

<main>
    <div class="endereco-container">

        <h2>Cadastrar Novo Endereço</h2>

        <form id="formEndereco">

            <div class="form-group">
                <label>CEP</label>
                <input type="text" id="cep" placeholder="00000-000" maxlength="9" required>
            </div>

            <div class="form-group">
                <label>Rua</label>
                <input type="text" id="rua" required>
            </div>

            <div class="form-group">
                <label>Número</label>
                <input type="text" id="numero" required>
            </div>

            <div class="form-group">
                <label>Bairro</label>
                <input type="text" id="bairro" required>
            </div>

            <div class="form-group">
                <label>Cidade</label>
                <input type="text" id="cidade" required>
            </div>

            <div class="form-group">
                <label>Estado</label>
                <select id="estado" required>
                    <option value="">Selecione...</option>
                    <option>SP</option>
                    <option>DF</option>
                    <option>RJ</option>
                    <option>MG</option>
                    <option>ES</option>
                    <option>PR</option>
                    <option>SC</option>
                    <option>RS</option>
                    <option>BA</option>
                    <option>PE</option>
                    <option>CE</option>
                </select>
            </div>

            <div class="form-group">
                <label>Complemento (opcional)</label>
                <input type="text" id="complemento">
            </div>

            <button class="btn-primary" type="submit">Salvar Endereço</button>

        </form>

        <a href="carrinho_checkout.html" class="back-link">⟵ Voltar ao Checkout</a>
    </div>
</main>

<script>
    const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));

    if (!usuario) {
        alert("Você precisa estar logado!");
        window.location.href = "/SRC/LOGINS/login.html";
    }

    // ========= AUTO-PREENCHER POR CEP (ViaCEP) =========
    document.getElementById("cep").addEventListener("blur", async () => {
        const cep = document.getElementById("cep").value.replace("-", "");

        if (cep.length !== 8) return;

        try {
            const req = await fetch(`https://viacep.com.br/ws/${cep}/json/`);

            const data = await req.json();

            if (!data.erro) {
                rua.value = data.logradouro;
                bairro.value = data.bairro;
                cidade.value = data.localidade;
                estado.value = data.uf;
            }

        } catch (e) {
            console.log("Erro ao buscar CEP:", e);
        }
    });


    // ========= SALVAR ENDEREÇO NO BANCO =========
    document.getElementById("formEndereco").addEventListener("submit", async e => {
        e.preventDefault();

        const dados = {
            id_usuario: usuario.id,
            cep: cep.value,
            rua: rua.value,
            numero: numero.value,
            bairro: bairro.value,
            cidade: cidade.value,
            estado: estado.value,
            complemento: complemento.value
        };

        try {
            const req = await fetch("http://127.0.0.1:3000/api/enderecos/adicionar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dados)
            });

            const res = await req.json();

            if (!res.success) {
                alert("❌ Erro: " + res.message);
                return;
            }

            alert("✅ Endereço cadastrado!");

            window.location.href = "carrinho_checkout.html";

        } catch (err) {
            console.error(err);
            alert("Erro ao conectar com o servidor.");
        }
    });
</script>

</body>
</html>
